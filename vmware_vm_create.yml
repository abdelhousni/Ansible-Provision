---
- name: Create VM on VCenter
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    cluster: domain-c26
    datastore: datastore-38
    folder: group-v28
    resource_pool: resgroup-27
    vm_names: "{{ vm_name.split(',') }}"
    source_vm_id: "test"
    
  tasks:
    #- name: Change facts if running Windows
    #  set_fact:
    #    source_vm_id: 
    #  when: guest_OS == "Windows64"

    #- name: Change facts if running RHEL8
    #  set_fact:
    #    source_vm_id: 
    #  when: guest_OS == "RHEL_8_64"
     
    - name: Create and run VM
      vmware.vmware_rest.vcenter_vm:
        vcenter_validate_certs: False
        placement:
          cluster: '{{ cluster_id }}'
          datastore: '{{ datastore_id }}'
          folder: '{{ folder_id }}'
          resource_pool: '{{ resource_pool_id }}'
        name: "{{ item }}"
        power_on: "{{ powered_on }}"
        source: "{{ source_vm_id }}"
        guest_OS: "{{ guest_OS }}"
      loop: "{{ vm_names }}"